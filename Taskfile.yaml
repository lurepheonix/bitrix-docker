version: '3'

vars:
  ENV_FILE: .env
  BACKUP_DIR: ./backups
  DECOMPRESS: false

dotenv: ['.env', '{{.ENV}}/.env.', '{{.HOME}}/.env']

tasks:
  backup-database:
    desc: Create and retrieve a MySQL backup from a remote server.
    cmds:
      - bash ./bin/backup_database.sh 
        {{.REMOTE_DB_LOGIN}} {{.REMOTE_DB_NAME}} {{.REMOTE_DB_USER}} {{.REMOTE_DB_PASSWORD}} {{.BACKUP_DIR}} {{.DECOMPRESS}}
  restore-database:
    desc: Restore a MySQL database from a file to a Docker container.
    cmds:
      - |
        if [[ -z "{{.RESTORE_FILE}}" ]]; then
          echo "Error: RESTORE_FILE variable is required for restore-database task."
          exit 1
        fi
      - source {{.ENV_FILE}}
      - cat "{{.RESTORE_FILE}}" | pv | 
        docker compose exec -T db /usr/bin/mysql -u {{.MYSQL_USER}} --password="{{.MYSQL_PASSWORD}}" "{{.MYSQL_DATABASE}}"
  fix-sql-dump:
    desc: Fix SQL dump generated by MariaDB by removing problematic lines.
    cmds:
      - |
        if [[ -z "{{.SQL_FILE}}" ]]; then
          echo "Error: SQL_FILE variable is required for fix-sql-dump task."
          exit 1
        fi
      - |
        sed -i '/^\/\*!999999\\- enable the sandbox mode \*\//d' "{{.SQL_FILE}}"
      - |
        echo "Fixed SQL dump file: {{.SQL_FILE}}"
  change-site-directory:
    desc: Change directory for website by site ID
    cmds:
      - |
        if [[ -z "{{.SITE_ID}}" ]]; then
          echo "Error: SITE_ID variable is required for change-site-directory task."
          exit 1
        fi
      - |
        if [[ -z "{{.DOCROOT}}" ]]; then
        echo "Error: DOCROOT variable is required for change-site-directory task."
        exit 1
        fi
      - source {{.ENV_FILE}}
      - docker compose exec -T db /usr/bin/mysql
        -u {{.MYSQL_USER}} --password="{{.MYSQL_PASSWORD}}" "{{.MYSQL_DATABASE}}" 
        -e "UPDATE b_lang SET DOC_ROOT='{{.DOCROOT}}' WHERE LID='{{.SITE_ID}}'"
  php-bash:
    desc: Enter PHP container with Bash 
    cmds:
      - docker compose exec -it php /bin/bash
  clear-cache: 
    desc: Clears bitrix cache
    cmds:
      - sudo rm -rf {{.BX_DIR | default "src"}}/bitrix/cache
      - sudo rm -rf {{.BX_DIR | default "src"}}/bitrix/managed_cache
  change-installation-id:
    desc: Change installation ID. Replace admin_passwordh and TEMPORARY_CACHE.
    cmds:
      - |
        if [[ -z "{{.ADMIN_PASSWORDH_VALUE}}" ]]; then
          echo "Error: ADMIN_PASSWORDH_VALUE variable is required for extend-trial task."
          exit 1
        fi
      - |
        if [[ -z "{{.TEMPORARY_CACHE_VALUE}}" ]]; then
          echo "Error: TEMPORARY_CACHE_VALUE variable is required for extend-trial task."
          exit 1
        fi
      - source {{.ENV_FILE}}
      - docker compose exec -T db /usr/bin/mysql
        -u {{.MYSQL_USER}} --password="{{.MYSQL_PASSWORD}}" "{{.MYSQL_DATABASE}}" 
        -e "UPDATE b_option SET VALUE='{{.ADMIN_PASSWORDH_VALUE}}' WHERE NAME='admin_passwordh'"
      - echo '<?define("TEMPORARY_CACHE", "{{.TEMPORARY_CACHE_VALUE}}");?>' | sudo tee {{.BX_DIR | default "src"}}/bitrix/modules/main/admin/define.php > /dev/null
      - task: clear-cache
